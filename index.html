<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Supply Chain Visualization</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #map {
            width: 50%;
            height: 60vh;
            float: left;
        }
        #data-panel {
            width: 50%;
            height: 60vh;
            float: right;
            overflow: auto;
        }
        #scatter-container {
            width: 90%; /* Full width */
            height: 20vh; /* Adjusted to not take full screen */
        }
        canvas {
            width: 100%; /* Ensures canvas takes the full width of its container */
            height: 0%; /* Height will adjust to fill the container */
        }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <div id="data-panel">
      <h1>Order Quantities</h1>
      <label for="countrySelect">Select a country:</label>
      <select id="countrySelect">
        <option value="Germany">Germany</option>
        <option value="Belgium">Belgium</option>
        <option value="Czech Republic">Czech Republic</option>
        <option value="Portugal">Portugal</option>
        <option value="Poland">Poland</option>
        <option value="Sweden">Sweden</option>
        <option value="Spain">Spain</option>
        <option value="France">France</option>
        <option value="Greece">Greece</option>
        <option value="United Kingdom">United Kingdom</option>
        <option value="Slovenia">Slovenia</option>
        <option value="Finland">Finland</option>
        <option value="Norway">Norway</option>
        <option value="Croatia">Croatia</option>
        <option value="Lithuania">Lithuania</option>
        <option value="Netherlands">Netherlands</option>
        <option value="Hungary">Hungary</option>
        <option value="Latvia">Latvia</option>
        <option value="Italy">Italy</option>
        <option value="Denmark">Denmark</option>
        <option value="Switzerland">Switzerland</option>
      </select>
      <label for="yearSelect">Select a year:</label>
      <select id="yearSelect">
        <option value="2025">2025</option>
        <option value="2024">2024</option>
        <option value="2023">2023</option>
        <option value="2022">2022</option>
      </select>
      <label for="productSelect">Select a product:</label>
      <select id="productSelect">
        <option value="EV Car Battery - FP">EV Car Battery - FP</option>
        <option value="EV Home Battery - FP">EV Home Battery - FP</option>
        <option value="Battery Cells">Battery Cells</option>
        <option value="Battery Management System (BMS)">
          Battery Management System (BMS)
        </option>
        <option value="Wiring and Connectors">Wiring and Connectors</option>
        <option value="Charge Controller">Charge Controller</option>
        <option value="Thermal Management System">
          Thermal Management System
        </option>
        <option value="Enclosure">Enclosure</option>
        <option value="Miscellaneous">Miscellaneous</option>
        <option value="Insulation Materials">Insulation Materials</option>
        <option value="Inverter">Inverter</option>
        <option value="Monitoring system">Monitoring system</option>
      </select>
      <canvas id="myChart"></canvas>
      <canvas id="myChartPie"></canvas>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="text/javascript" src="europe.js"></script>
    <script type="text/javascript" src="script.js"></script>
    <canvas id="myChart"></canvas>
    <canvas id="myChartPie"></canvas>
    <canvas id="myScatterChart" style="width: 100%; height: 300px;"></canvas>

    </div>
    <div id="scatter-container">
      <canvas id="myScatterChart"></canvas>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script type="text/javascript" src="europe.js"></script>
    <script type="text/javascript" src="script.js"></script>
    <script>
      // Month mapping
      const monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
      ];
    
// Fetching data and updating charts
function fetchData() {
    const country = document.getElementById("countrySelect").value;
    const year = document.getElementById("yearSelect").value;
    const product = document.getElementById("productSelect").value;
    const url = `server.php?country=${encodeURIComponent(country)}&year=${encodeURIComponent(year)}&product=${encodeURIComponent(product)}`;

    fetch(url)
    .then(response => response.json())
    .then(data => {
        updateBarChart(data.monthlyData);
        updatePieChart(data.categoryData);
    })
    .catch(error => console.error("Error:", error));
}

    
      const ctxBar = document.getElementById("myChart").getContext("2d");
      const myBarChart = new Chart(ctxBar, {
        type: "bar",
        data: {
          labels: [], // Will be set when data is processed
          datasets: [{
            label: "Total Order Quantities by Month",
            backgroundColor: "rgba(54, 162, 235, 0.2)",
            borderColor: "rgba(54, 162, 235, 1)",
            borderWidth: 1,
            data: [], // Will be set when data is processed
          }],
        },
        options: {
          scales: {
            y: {
              beginAtZero: true,
            },
          },
        },
      });
    
      function updateBarChart(data) {
        myBarChart.data.labels = data.map(item => monthNames[item.Month - 1]); // Adjust month number to name
        myBarChart.data.datasets[0].data = data.map(item => item.TotalQuantity);
        myBarChart.update();
      }
    
      const ctxPie = document.getElementById("myChartPie").getContext("2d");
const myPieChart = new Chart(ctxPie, {
    type: "pie",
    data: {
        labels: [], // This will be updated dynamically
        datasets: [{
            label: "Material Share",
            backgroundColor: ["#FF6384", "#36A2EB", "#FFCE56", "#4BC0C0", "#F77825"], // Color array
            data: [], // Data will be set when fetched
        }],
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
            display: true, // Ensure the legend is displayed
            position: 'bottom' // Positioning the legend at the bottom
        },
        plugins: {
            legend: {
                labels: {
                    boxWidth: 10,
                    padding: 20 // Optional: Adjust padding for legibility
                }
            }
        }
    }
});

    
      function updatePieChart(data) {
    // Update the pie chart with category names and their respective quantities
    myPieChart.data.labels = data.map(item => item.ProductCategory); // Set labels to product categories
    myPieChart.data.datasets[0].data = data.map(item => item.TotalQuantity); // Set data to quantities
    myPieChart.update(); // Redraw the pie chart with new data
}

document.getElementById("countrySelect").addEventListener("change", fetchData);
document.getElementById("yearSelect").addEventListener("change", fetchData);
document.getElementById("productSelect").addEventListener("change", fetchData);

// Initial data fetch to populate charts
fetchData();
const ctxScatter = document.getElementById('myScatterChart').getContext('2d');
const myScatterChart = new Chart(ctxScatter, {
    type: 'scatter',
    data: {
        datasets: [{
            label: 'Goods Receipt Date Difference',
            data: [],
            backgroundColor: 'rgba(255, 99, 132, 1)',
            borderColor: 'rgba(255, 99, 132, 1)'
        }, {
            label: 'Arrival Date Yard Difference',
            data: [],
            backgroundColor: 'rgba(54, 162, 235, 1)',
            borderColor: 'rgba(54, 162, 235, 1)'
        }, {
            label: 'Vendor Shipment Date Difference',
            data: [],
            backgroundColor: 'rgba(255, 206, 86, 1)',
            borderColor: 'rgba(255, 206, 86, 1)'
        }]
    },
    options: {
        scales: {
            x: {
                type: 'linear',
                position: 'bottom',
                title: {
                    display: true,
                    text: 'Purchase Order Quantity'
                }
            },
            y: {
                title: {
                    display: true,
                    text: 'Average Days Difference'
                }
            }
        },
        responsive: true,
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return `${context.dataset.label}: ${context.parsed.y} days`;
                    }
                }
            }
        }
    }
});

function updateScatterChart(data) {
    myScatterChart.data.datasets[0].data = data.map(item => ({ x: item.PurchaseQuantity, y: item.GoodsReceiptDate }));
    myScatterChart.data.datasets[1].data = data.map(item => ({ x: item.PurchaseQuantity, y: item.ArrivalDateYard }));
    myScatterChart.data.datasets[2].data = data.map(item => ({ x: item.PurchaseQuantity, y: item.VendorShipmentDate }));
    myScatterChart.update();
}

// Function to fetch and update data, ensure this is triggered appropriately
function fetchScatterData() {
    const url = 'server.php?query=purchaseData'; // Adjust as per actual API

    fetch(url)
        .then(response => response.json())
        .then(data => {
            updateScatterChart(data.purchaseData);
        })
        .catch(error => console.error('Error loading scatter plot data:', error));
}

// Initial call to populate the scatter plot
fetchScatterData();

    </script>
    

  </body>
</html>
